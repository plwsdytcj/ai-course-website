<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¾®ä¿¡æ”¯ä»˜ - AIæ–‡ç§‘ç”Ÿè¯¾ç¨‹</title>
  <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 28px;
    }
    .order-info {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      font-size: 16px;
    }
    .info-label {
      color: #666;
    }
    .info-value {
      font-weight: 600;
      color: #333;
    }
    .amount {
      font-size: 24px;
      color: #667eea;
    }
    .qr-code {
      background: white;
      border: 2px solid #eee;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
    }
    .qr-code img {
      width: 200px;
      height: 200px;
      margin: 0 auto;
    }
    .tips {
      text-align: center;
      color: #666;
      font-size: 14px;
      line-height: 1.6;
    }
    .button {
      width: 100%;
      padding: 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 20px;
    }
    .button:hover {
      background: #5568d3;
    }
    .demo-notice {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      color: #856404;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ’° å……å€¼å¯¹è¯æ¬¡æ•°</h1>
    
    <div class="demo-notice">
      âš ï¸ æ¼”ç¤ºç¯å¢ƒ<br>
      å®é™…æ”¯ä»˜éœ€è¦å®Œæ•´é…ç½®å¾®ä¿¡å•†æˆ·å·å’Œè¯ä¹¦
    </div>

    <div class="order-info">
      <div class="info-row">
        <span class="info-label">å……å€¼å¥—é¤</span>
        <span class="info-value" id="package">1å…ƒ50æ¬¡</span>
      </div>
      <div class="info-row">
        <span class="info-label">æ”¯ä»˜é‡‘é¢</span>
        <span class="info-value amount" id="amount">Â¥1.00</span>
      </div>
      <div class="info-row">
        <span class="info-label">è®¢å•å·</span>
        <span class="info-value" id="orderno" style="font-size: 12px;">...</span>
      </div>
    </div>

    <div class="tips" style="margin: 30px 0;">
      ğŸ’¡ JSAPI æ”¯ä»˜æµç¨‹ï¼š<br><br>
      1. ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è°ƒèµ·å¾®ä¿¡æ”¯ä»˜<br>
      2. è¾“å…¥å¯†ç å®Œæˆæ”¯ä»˜<br>
      3. æ”¯ä»˜æˆåŠŸåè‡ªåŠ¨åˆ°è´¦<br><br>
      æœ‰æ•ˆæœŸï¼š30åˆ†é’Ÿ
    </div>

    <button class="button" onclick="startPay()" id="payBtn">ç«‹å³æ”¯ä»˜</button>
    <button class="button" onclick="testRecharge()" style="background: #28a745;">æµ‹è¯•å……å€¼ï¼ˆå¼€å‘ç”¨ï¼‰</button>
    <button class="button" onclick="goBack()" style="background: #6c757d;">è¿”å›å…¬ä¼—å·</button>
  </div>

  <script>
    // ä»URLè·å–å‚æ•°
    const urlParams = new URLSearchParams(window.location.search);
    const orderNo = urlParams.get('order');
    const priceKey = urlParams.get('price');
    const openId = urlParams.get('openid');

    const prices = {
      '1': { desc: '1å…ƒ50æ¬¡', amount: 1, credits: 50 },
      '5': { desc: '5å…ƒ300æ¬¡', amount: 5, credits: 300 },
      '10': { desc: '10å…ƒ700æ¬¡', amount: 10, credits: 700 }
    };

    // æ˜¾ç¤ºè®¢å•ä¿¡æ¯
    if (priceKey && prices[priceKey]) {
      document.getElementById('package').textContent = prices[priceKey].desc;
      document.getElementById('amount').textContent = 'Â¥' + prices[priceKey].amount + '.00';
    }

    if (orderNo) {
      document.getElementById('orderno').textContent = orderNo;
      
      // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è°ƒèµ·æ”¯ä»˜
      if (typeof WeixinJSBridge !== 'undefined') {
        startPay();
      } else {
        document.addEventListener('WeixinJSBridgeReady', function() {
          startPay();
        });
      }
    }

    // å¾®ä¿¡JSAPIæ”¯ä»˜
    async function startPay() {
      try {
        // ä»åç«¯è·å–æ”¯ä»˜å‚æ•°
        const response = await fetch(`/api/pay/params/${orderNo}`);
        const data = await response.json();
        
        if (!data.payParams) {
          alert('âŒ è·å–æ”¯ä»˜å‚æ•°å¤±è´¥');
          return;
        }

        const { appId, timeStamp, nonceStr, package: packageStr, signType, paySign } = data.payParams;

        // æ£€æŸ¥æ˜¯å¦åœ¨å¾®ä¿¡ç¯å¢ƒ
        if (typeof WeixinJSBridge === 'undefined') {
          alert('è¯·åœ¨å¾®ä¿¡ä¸­æ‰“å¼€');
          return;
        }

        // è°ƒèµ·å¾®ä¿¡æ”¯ä»˜
        WeixinJSBridge.invoke(
          'getBrandWCPayRequest',
          {
            appId: appId,
            timeStamp: timeStamp,
            nonceStr: nonceStr,
            package: packageStr,
            signType: signType,
            paySign: paySign
          },
          function(res) {
            if (res.err_msg == "get_brand_wcpay_request:ok") {
              // æ”¯ä»˜æˆåŠŸï¼Œç›´æ¥å…³é—­é¡µé¢
              WeixinJSBridge.call('closeWindow');
            } else if (res.err_msg == "get_brand_wcpay_request:cancel") {
              // ç”¨æˆ·å–æ¶ˆæ”¯ä»˜ï¼Œå…³é—­é¡µé¢
              WeixinJSBridge.call('closeWindow');
            } else {
              // æ”¯ä»˜å¤±è´¥ï¼Œæç¤ºåå…³é—­
              alert('æ”¯ä»˜å¤±è´¥ï¼Œè¯·é‡è¯•');
              setTimeout(() => {
                WeixinJSBridge.call('closeWindow');
              }, 1500);
            }
          }
        );
      } catch (error) {
        console.error('è°ƒèµ·æ”¯ä»˜å¤±è´¥:', error);
        alert('âš ï¸ å½“å‰ä¸ºæ¼”ç¤ºç¯å¢ƒ\n\nè¯·ç‚¹å‡»ä¸‹æ–¹"æµ‹è¯•å……å€¼"æŒ‰é’®æ¨¡æ‹Ÿå……å€¼');
      }
      
      /* å®é™…çš„æ”¯ä»˜ä»£ç ç¤ºä¾‹ï¼š
      
      // æ–¹å¼1ï¼šä½¿ç”¨ WeixinJSBridge (æ¨è)
      if (typeof WeixinJSBridge != "undefined") {
        WeixinJSBridge.invoke(
          'getBrandWCPayRequest', {
            "appId": "wx6f8828f74075acb4",     // å…¬ä¼—å·AppID
            "timeStamp": "1234567890",         // æ—¶é—´æˆ³
            "nonceStr": "randomstring",        // éšæœºå­—ç¬¦ä¸²
            "package": "prepay_id=xxxxx",      // é¢„æ”¯ä»˜äº¤æ˜“ä¼šè¯æ ‡è¯†
            "signType": "RSA",                 // ç­¾åæ–¹å¼
            "paySign": "xxxxx"                 // ç­¾å
          },
          function(res) {
            if (res.err_msg == "get_brand_wcpay_request:ok") {
              alert('æ”¯ä»˜æˆåŠŸï¼');
              window.location.href = 'weixin://';
            } else if (res.err_msg == "get_brand_wcpay_request:cancel") {
              alert('æ”¯ä»˜å–æ¶ˆ');
            } else {
              alert('æ”¯ä»˜å¤±è´¥: ' + res.err_msg);
            }
          }
        );
      }
      
      // æ–¹å¼2ï¼šä½¿ç”¨ wx.chooseWXPay (éœ€è¦å…ˆé…ç½®wx.config)
      wx.chooseWXPay({
        timestamp: 0,
        nonceStr: '',
        package: '',
        signType: 'RSA',
        paySign: '',
        success: function (res) {
          alert('æ”¯ä»˜æˆåŠŸ');
        },
        cancel: function (res) {
          alert('æ”¯ä»˜å–æ¶ˆ');
        },
        fail: function (res) {
          alert('æ”¯ä»˜å¤±è´¥');
        }
      });
      
      */
    }

    // æµ‹è¯•å……å€¼ï¼ˆå¼€å‘ç¯å¢ƒç”¨ï¼‰
    function testRecharge() {
      if (!openId) {
        alert('âŒ ç¼ºå°‘ openId å‚æ•°');
        return;
      }

      const credits = prices[priceKey]?.credits || 50;
      
      if (confirm(`ç¡®è®¤æµ‹è¯•å……å€¼ ${credits} æ¬¡å¯¹è¯ï¼Ÿ`)) {
        fetch(`/api/pay/test?openid=${openId}&credits=${credits}`)
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              alert(`âœ… ${data.message}\n\nå½“å‰ä½™é¢ï¼š${data.newBalance} æ¬¡`);
              setTimeout(() => {
                goBack();
              }, 1500);
            } else {
              alert('âŒ å……å€¼å¤±è´¥ï¼š' + data.message);
            }
          })
          .catch(err => {
            alert('âŒ è¯·æ±‚å¤±è´¥ï¼š' + err.message);
          });
      }
    }

    function goBack() {
      // å…³é—­å½“å‰é¡µé¢ï¼Œè¿”å›å¾®ä¿¡
      if (typeof WeixinJSBridge !== 'undefined') {
        WeixinJSBridge.call('closeWindow');
      } else {
        window.close();
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆåçš„æç¤º
    window.onload = function() {
      console.log('è®¢å•ä¿¡æ¯:', { orderNo, priceKey, openId });
    };
  </script>
</body>
</html>

