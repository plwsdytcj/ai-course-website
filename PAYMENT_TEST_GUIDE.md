# 微信支付测试指南

## ✅ 已完成配置

- ✅ 商户号：`1724804931`
- ✅ API密钥：已配置
- ✅ 证书序列号：已配置
- ✅ 商户私钥：已加载成功
- ✅ 支付代码：已实现

## 🧪 测试流程

### 1. 基础功能测试

在微信公众号中测试：

```
发送: "余额"
期望: 显示剩余次数和累计对话数

发送: "充值"
期望: 显示充值套餐列表

发送: "充值 1"
期望: 返回支付订单信息和支付链接
```

### 2. 支付功能测试

**注意事项：**
- ⚠️ 必须在微信客户端内打开（不能在浏览器）
- ⚠️ 必须使用 HTTPS（目前使用HTTP会有问题）
- ⚠️ 首次测试建议用 0.01 元小额测试

**测试步骤：**

```
步骤1: 发送 "充值 1"
   → 收到订单信息和支付链接

步骤2: 点击支付链接
   → 在微信内打开支付页面

步骤3: 点击"立即支付"按钮
   → 调起微信支付
   → 输入密码
   → 完成支付

步骤4: 发送 "余额"
   → 确认credits已到账
```

### 3. 日志监控

实时查看支付日志：

```bash
pm2 logs wechat-server -f
```

关键日志：
```
📤 调用微信统一下单API...
✅ 统一下单成功，prepay_id: wx...
收到支付回调: {...}
✅ 充值成功: oXXX... +50 credits, 新余额: 53
```

## 🔧 目前存在的问题

### 1. HTTPS 要求

**问题**：微信支付要求必须使用 HTTPS

**解决方案**：

```bash
# 安装 SSL 证书
sudo certbot --nginx -d wenkexueai.com

# 或使用 acme.sh
curl https://get.acme.sh | sh
acme.sh --issue -d wenkexueai.com --nginx
```

配置好后，将所有 `http://` 改为 `https://`

### 2. 支付域名配置

**需要在微信商户平台配置：**

1. 登录 https://pay.weixin.qq.com/
2. 进入【产品中心】->【开发配置】
3. 配置 **JSAPI支付授权目录**：
   ```
   https://wenkexueai.com/
   ```
4. 保存并等待生效

### 3. 支付回调验证

当前代码使用简化的回调处理，生产环境需要：

- ✅ 验证微信签名
- ✅ 验证订单金额
- ✅ 防止重复回调
- ✅ 记录支付日志

## 📊 测试清单

- [ ] 发送"余额"查看余额
- [ ] 发送"充值"查看套餐
- [ ] 发送"充值 1"生成订单
- [ ] 点击支付链接打开页面
- [ ] 配置 HTTPS
- [ ] 在微信商户平台配置域名
- [ ] 点击"立即支付"调起微信支付
- [ ] 完成支付流程
- [ ] 验证credits到账
- [ ] 测试对话扣费

## 🎯 快速测试（跳过真实支付）

如果暂时不想配置HTTPS，可以使用测试接口：

```bash
# 直接给用户充值 50 credits
curl "https://wenkexueai.com/api/pay/test?openid=用户openid&credits=50"
```

或者在支付页面点击"测试充值"按钮。

## 💰 支付套餐

| 套餐 | 金额 | Credits | 实际价格 |
|------|------|---------|----------|
| 1 | 1元 | 50次 | 0.02元/次 |
| 5 | 5元 | 300次 | 0.017元/次 |
| 10 | 10元 | 700次 | 0.014元/次 |

## 🔍 故障排查

### 问题1：调起支付失败

**可能原因：**
- 未使用 HTTPS
- 未在微信客户端打开
- 支付域名未配置

**解决方法：**
1. 检查是否使用 HTTPS
2. 确认在微信内打开（不是浏览器）
3. 检查商户平台域名配置

### 问题2：支付成功但未到账

**可能原因：**
- 支付回调失败
- OpenID 不匹配

**解决方法：**
1. 查看支付回调日志
2. 检查订单的 attach 字段
3. 使用测试接口手动充值

### 问题3：API 调用失败

**可能原因：**
- 签名错误
- 证书配置错误
- 商户号不匹配

**解决方法：**
1. 检查环境变量配置
2. 确认证书文件存在且权限正确
3. 查看错误日志

## 📞 技术支持

- **微信支付文档**: https://pay.weixin.qq.com/wiki/doc/apiv3/
- **商户平台**: https://pay.weixin.qq.com/
- **技术支持电话**: 95017

## 🚀 下一步

1. **配置 HTTPS**（必需）
   ```bash
   sudo certbot --nginx -d wenkexueai.com
   ```

2. **配置支付域名**（必需）
   - 登录商户平台
   - 配置 JSAPI 支付授权目录

3. **小额测试**
   - 使用 0.01 元测试完整流程

4. **正式上线**
   - 确认所有功能正常
   - 监控支付回调
   - 记录交易日志

## ⚡ 快速开始

```bash
# 1. 查看服务状态
pm2 status

# 2. 查看实时日志
pm2 logs wechat-server -f

# 3. 在微信公众号测试
发送: "余额"
发送: "充值"
发送: "充值 1"

# 4. 配置 HTTPS（必需）
sudo certbot --nginx -d wenkexueai.com

# 5. 重启服务
pm2 restart wechat-server
```

祝测试顺利！🎉

