# 微信公众平台 IP 白名单配置指南

## ⚠️ 问题现象

```
获取 access_token 失败:
errcode: 40164
errmsg: 'invalid ip 47.100.59.61 not in whitelist'
```

## 🔍 问题原因

微信公众平台为了安全，要求调用API的服务器IP必须在白名单中。

## ✅ 解决方案

### 第1步：登录微信公众平台

访问：**https://mp.weixin.qq.com/**

使用管理员账号登录

---

### 第2步：进入基本配置

点击左侧菜单：
```
设置与开发 → 基本配置
```

---

### 第3步：找到IP白名单

往下滚动页面，找到 **"IP白名单"** 区域

会看到类似这样的界面：
```
┌─────────────────────────────────┐
│ IP白名单                         │
│                                 │
│ 当前白名单IP：                   │
│ 暂无                            │
│                                 │
│ [修改] 按钮                      │
└─────────────────────────────────┘
```

---

### 第4步：点击修改

点击 **[修改]** 按钮

---

### 第5步：添加服务器IP

在弹出的输入框中输入：

```
47.100.59.61
```

**注意事项：**
- ✅ 只填写IP地址，不要加端口号
- ✅ 一行一个IP（如果有多个）
- ✅ 不要有多余的空格

**格式示例：**
```
47.100.59.61
```

或者如果有多个IP：
```
47.100.59.61
123.456.789.0
```

---

### 第6步：确认并保存

1. 输入完成后，点击 **[确定]** 按钮
2. 可能需要**管理员扫码确认**
3. 保存成功

---

### 第7步：等待生效

- 通常 **立即生效**
- 最多等待 **3-5分钟**

---

## 🧪 验证配置

### 方法1：运行测试脚本

```bash
cd /home/admin/0801/0802/ai-course-website
./test-access-token.sh
```

**成功的输出：**
```
✅ 获取 Access Token 成功！
说明 IP 白名单配置正确
```

---

### 方法2：查看服务日志

```bash
pm2 logs wechat-server --lines 20 --nostream
```

**成功的日志：**
```
✓ 获取 access_token 成功
✓ 客服消息发送成功
```

---

### 方法3：实际测试

1. 在公众号发送消息
2. 或者完成一次充值
3. 应该能收到推送消息

---

## 📋 常见问题

### Q1: 找不到 IP白名单 选项？

**可能原因：**
- 账号权限不够
- 未认证的订阅号可能没有此功能

**解决方法：**
- 使用管理员账号登录
- 认证公众号

---

### Q2: 添加后还是报错？

**可能原因：**
- 刚添加，还没生效
- IP地址填写错误

**解决方法：**
```bash
# 确认服务器IP
curl ifconfig.me

# 应该显示：47.100.59.61
```

等待3-5分钟后重试

---

### Q3: 可以添加多个IP吗？

**可以！**

如果有多台服务器，可以添加多个IP，每行一个：
```
47.100.59.61
123.456.789.0
111.222.333.444
```

---

### Q4: IP会变吗？

**云服务器通常不会变**

如果是：
- ✅ 阿里云ECS - IP固定
- ✅ 腾讯云CVM - IP固定
- ⚠️ 家用宽带 - IP可能变动

---

## 🔒 安全提示

1. **只添加您的服务器IP**
   - 不要添加不相关的IP
   - 定期检查和清理

2. **保护好管理员账号**
   - IP白名单是重要的安全配置
   - 不要随意透露给他人

3. **记录IP变更**
   - 如果更换服务器
   - 记得更新IP白名单

---

## 📞 技术支持

如果遇到问题：

1. **查看官方文档**
   https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Get_access_token.html

2. **联系微信客服**
   公众平台右下角 → 客服

3. **查看错误码**
   https://developers.weixin.qq.com/doc/offiaccount/Getting_Started/Global_Return_Code.html

---

## ✅ 配置完成清单

- [ ] 登录微信公众平台
- [ ] 进入"设置与开发 → 基本配置"
- [ ] 找到"IP白名单"
- [ ] 点击"修改"
- [ ] 添加IP：`47.100.59.61`
- [ ] 确认保存
- [ ] 运行测试脚本验证
- [ ] 查看日志确认成功

---

## 🎯 配置成功后

一旦IP白名单配置成功，您的服务将能够：

✅ 获取 access_token
✅ 发送客服消息
✅ 发送模板消息
✅ 调用其他微信API

**充值成功后就能收到推送消息了！** 🎉

